{% extends 'base.html' %}

{% block title %}Bandeja de Mensajes - Plataforma Web Escolar{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h3 mb-0">Bandeja de Mensajes</h1>
        <p class="text-muted">Centro de notificaciones y alertas del sistema</p>
    </div>
    <div class="col-auto">
        <span class="badge bg-primary fs-6">{{ mensajes_no_leidos }} sin leer</span>
    </div>
</div>

<!-- Filtros de Mensajes -->
<div class="card mb-4">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col">
                <h6 class="mb-0">
                    <i class="fas fa-filter me-2"></i>Filtrar Mensajes
                </h6>
            </div>
            <div class="col-auto">
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" onclick="filtrarMensajes('todos')">
                        Todos
                    </button>
                    <button class="btn btn-outline-warning" onclick="filtrarMensajes('no-leidos')">
                        No Leídos
                    </button>
                    <button class="btn btn-outline-danger" onclick="filtrarMensajes('alta')">
                        Prioridad Alta
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Mensajes -->
<div class="row">
    <div class="col-12">
        {% for mensaje in mensajes %}
        <div class="card mb-3 mensaje-item" 
             data-leido="{{ mensaje.leido|yesno:'true,false' }}" 
             data-prioridad="{{ mensaje.prioridad }}">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-auto">
                        {% if mensaje.tipo == 'recordatorio' %}
                            <i class="fas fa-bell fa-2x text-warning"></i>
                        {% elif mensaje.tipo == 'alerta' %}
                            <i class="fas fa-exclamation-triangle fa-2x text-danger"></i>
                        {% elif mensaje.tipo == 'informativo' %}
                            <i class="fas fa-info-circle fa-2x text-info"></i>
                        {% elif mensaje.tipo == 'confirmacion' %}
                            <i class="fas fa-check-circle fa-2x text-success"></i>
                        {% elif mensaje.tipo == 'reporte' %}
                            <i class="fas fa-chart-bar fa-2x text-primary"></i>
                        {% endif %}
                    </div>
                    <div class="col">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1 {% if not mensaje.leido %}fw-bold{% endif %}">
                                    {{ mensaje.titulo }}
                                    {% if not mensaje.leido %}
                                        <span class="badge bg-primary ms-2">Nuevo</span>
                                    {% endif %}
                                    {% if mensaje.prioridad == 'alta' %}
                                        <span class="badge bg-danger ms-1">Alta Prioridad</span>
                                    {% endif %}
                                </h6>
                                <p class="mb-1 {% if not mensaje.leido %}text-dark{% else %}text-muted{% endif %}">
                                    {{ mensaje.mensaje }}
                                </p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ mensaje.fecha|timesince }} atrás
                                </small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                {% if not mensaje.leido %}
                                <button class="btn btn-outline-primary" onclick="marcarLeido({{ mensaje.id }})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                {% endif %}
                                <button class="btn btn-outline-secondary" onclick="archivarMensaje({{ mensaje.id }})">
                                    <i class="fas fa-archive"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="eliminarMensaje({{ mensaje.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay mensajes</h5>
                <p class="text-muted">Tu bandeja de mensajes está vacía.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Configuración de Notificaciones -->
<div class="card mt-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-cog me-2"></i>Configuración de Notificaciones
        </h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notif-email" checked>
                    <label class="form-check-label" for="notif-email">
                        Notificaciones por Email
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notif-recordatorios" checked>
                    <label class="form-check-label" for="notif-recordatorios">
                        Recordatorios de Pago
                    </label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notif-nuevas-cuotas" checked>
                    <label class="form-check-label" for="notif-nuevas-cuotas">
                        Nuevas Cuotas Asignadas
                    </label>
                </div>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="notif-vencimientos">
                    <label class="form-check-label" for="notif-vencimientos">
                        Alertas de Vencimiento
                    </label>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary">
                <i class="fas fa-save me-1"></i>Guardar Configuración
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filtrarMensajes(filtro) {
    const mensajes = document.querySelectorAll('.mensaje-item');
    const botones = document.querySelectorAll('.btn-group .btn');
    
    // Remover clase active de todos los botones
    botones.forEach(btn => btn.classList.remove('active'));
    
    // Agregar clase active al botón clickeado
    event.target.classList.add('active');
    
    mensajes.forEach(mensaje => {
        let mostrar = true;
        
        switch(filtro) {
            case 'no-leidos':
                mostrar = mensaje.dataset.leido === 'false';
                break;
            case 'alta':
                mostrar = mensaje.dataset.prioridad === 'alta';
                break;
            case 'todos':
            default:
                mostrar = true;
                break;
        }
        
        mensaje.style.display = mostrar ? 'block' : 'none';
    });
}

function marcarLeido(mensajeId) {
    // Simular marcado como leído
    const mensaje = document.querySelector(`[data-mensaje-id="${mensajeId}"]`);
    if (mensaje) {
        mensaje.dataset.leido = 'true';
        // Actualizar visualmente
        const badge = mensaje.querySelector('.badge');
        if (badge) badge.remove();
    }
    
    alert(`Mensaje ${mensajeId} marcado como leído`);
}

function archivarMensaje(mensajeId) {
    if (confirm('¿Desea archivar este mensaje?')) {
        alert(`Mensaje ${mensajeId} archivado`);
    }
}

function eliminarMensaje(mensajeId) {
    if (confirm('¿Está seguro de que desea eliminar este mensaje?')) {
        alert(`Mensaje ${mensajeId} eliminado`);
    }
}
</script>
{% endblock %}
